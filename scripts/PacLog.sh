#!/bin/env bash

awk -v date="$(date +%Y-%m-%d)" '$0 ~ date && $3 ~ /^(Running|transaction|upgraded|installed|removed)$/ {if ($3 == "Running") {pacman_line=$0; pacman_pending=1} else if (pacman_pending && $3 == "transaction" && $0 ~ /transaction started/) {print pacman_line; pacman_pending=0; print $0} else if ($3 == "transaction" || $3 == "upgraded" || $3 == "installed" || $3 == "removed") {pacman_pending=0; print $0}}' /var/log/pacman.log | awk '{if($2=="[PACMAN]") {printf "{\"transaction\":\"" $1 "\",";$1=$2=$3="";printf "\"command\":\"" $0 "\",\"packages\": "} else if($3=="transaction" && $4=="started") {printf "["} else if($3=="transaction" && $4=="completed") {printf "\n"} else {printf "{\"name\": \"" $4 "\", \"change\": \"" $3 "\", "; $1=$2=$3=$4="";printf "\"version\": \"" $0 "\"},"}}' | sed 's/,*$/]},/' | sed 's/    //g' | sed 's/   //g' | awk '{printf $0}' | sed 's/,*$/]/'| sed 's/^/[/'
